<!doctype html>
<head>
    <title>torero | Michael Pérez</title>
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport>
    <meta name="description" content="torero is a game of reflex and carnage">
    <meta name="og:title" content="torero | Michael Pérez">
    <meta name="og:description" content="torero is a game of reflex and carnage">
    <link ref="shortcut icon" href="/favicon.ico">
    <style>
     h1, h2, h3, h4, h5, h6, p {
         font-family: monospace;
         box-sizing: border-box;
     }
     .character {
         width: 30px;
         height: 30px;
         position: absolute;
         transform-origin: center center;
     }

     .screen {
         width: 100%;
         height: 100%;
         position: absolute;
         background-color: #212212;
     }

     .copy {
         width: 400px;
     }

     .copy--inverse {
         color: #FAFAFA;
     }
     .hidden {
         display: none;
     }

     #screen__wrapper {
         width: 400px;
         height: 400px;
         position: relative;
     }

     #toro {
         bottom: 5px;
         right: 5px;
     }

     #toro__body {
         background-color: #b200b2;
         height: 100%;
         width: 100%;
         transform-origin: center center;
     }

     #toro__load {
         background-color: #e36b64;
         height: 100%;;
         width: 100%;
         transform-origin: bottom;
     }

     #toro__horn--left {
         left: 2.5px;
     }

     #toro__horn--right {
         right: 2.5px;
     }

     #torero {
         top: 5px;
         left: 5px;
         background-color: #00b200;
     }

     #torero__cape {
         width: 30px;
         height: 15px;
         background-color: #00b2b2;
         position: relative;
         display: none;
         top: 5px;
         left: 100%;
     }

     .toro__horn {
         width: 7px;
         height: 7px;
         top: -2px;
         position: absolute;
         background-color: #dfe568;
     }

     #user-select, #waiting {
         display: flex;
         align-items: center;
         justify-content: center;
         flex-direction: column;
     }
     .selected {
         border-bottom: 1.5px dashed
     }

     .user-select__btn {
         width: 150px;
         height: 40px;
         background: transparent;
         color: #FAFAFA;
         font-family: monospace;
         letter-spacing: 2px;
         font-size: 18px;
         border: 1px dashed #FAFAFA;
         border-radius: 5px;
         cursor: pointer;
         transition: background-color .15s ease-out, border-style .15s ease-out;
     }

     .user-select__btn:hover {
         border-style: solid;
         background-color: #616161;
     }

     .user-select__btn:active {
         background-color: #424242;
         border-style: solid;
     }

     .user-select__btn:active, .user-select__btn:focus {
         outline: none;
     }

     .user-select__btn ~ .user-select__btn {
         margin-top: 10px;
     }

     #scoreboard__spectator {
         color: #757575;
     }
    </style>
</head>
<body>
    <div id="screen__wrapper">
        <div id="arena" class="screen">
            <div id="torero" class="character" data-x="0" data-y="0">
                <div id="torero__cape" data-visible="false"></div>
            </div>
            <div id="toro" class="character" data-x="0" data-y="0">
                <div id="toro__body" data-rotation="0">
                    <div id="toro__load" data-load="0"></div>
                    <div id="toro__horn--left" class="toro__horn"></div>
                    <div id="toro__horn--right" class="toro__horn"></div>
                </div>
            </div>
        </div>
        <div id="waiting" class="screen">
            <h1 id="waiting__prompt" class="copy--inverse"></h1>
        </div>
        <div id="user-select" class="screen">
            <h1 class="copy--inverse">Who do you want to be?</h1>
            <button data-user="TORO" class="user-select__btn">Toro</button>
            <button data-user="TORERO" class="user-select__btn">Torero</button>
            <button data-user="SPECTATOR" class="user-select__btn">Spectator</button>
        </div>
    </div>
    <section id="scoreboard" class="copy">
        <h1>Toro y tú</h1>
        <h3>Scoreboard</h3>
        <p><strong id="scoreboard__toro">Toro:</strong> <span id="toro__points">0</span> | <strong id="scoreboard__torero">Torero:</strong> <span id="torero__points">0</span> <small id="scoreboard__spectator"></small></p>
        <p><strong id="game-room-id">Waiting to connect to set game room id</strong></p>
    </section>
    <section id="instructions" class="copy">
        <hr>
        <h3>How to play</h3>
        <p>One player is the toro, another is the torero.</p>
        <p>The toro is rotated with "A" and "D", holding down the spacebar will charge a forward thrust.</p>
        <p>The torero is controlled with the arrow keys, enter unleashes their cape.</p>
        <p>The toro should go after the torero, but avoid the torero's cape.</p>
    </section>
    <script>

     const WS = new WebSocket('ws://localhost:8765'),
           ARENA_SCREEN = document.getElementById('arena'),
           USER_SELECT_SCREEN = document.getElementById('user-select'),
           WAITING_SCREEN = document.getElementById('waiting'),
           WAITING_PROMPT_EL = document.getElementById('waiting__prompt'),
           TORERO = document.getElementById('torero'),
           TORERO_CAPE = document.getElementById('torero__cape'),
           TORO = document.getElementById('toro'),
           TORO_LOAD = document.getElementById('toro__load'),
           TORO_BODY = document.getElementById('toro__body'),
           TORO_KEYS = new Set(['Space', 'KeyA', 'KeyD']),
           TORERO_KEYS = new Set(['ArrowLeft', 'ArrowUp', 'ArrowRight', 'ArrowDown', 'Enter']),
           TORO_POINTS = document.getElementById('toro__points'),
           TORERO_POINTS = document.getElementById('torero__points'),
           USER_TYPES = Object.freeze({
               TORO: Symbol.for('TORO'),
               TORERO: Symbol.for('TORERO'),
               SPECTATOR: Symbol.for('SPECTATOR')
           });

     let KEYS_DOWN = Array.from(TORO_KEYS).concat(Array.from(TORERO_KEYS)).reduce(
         (rv, k) => {
             rv[k] = false
             return rv
         },  {}),
         USER_TYPE = null,
         WAITING_PROMPT_INTERVAL = null;

     function setupGame() {
         document.addEventListener('keydown', onKeydown);
         document.addEventListener('keyup', onKeyup);

         setToro();
         setTorero();
     };

     function toroWin() {
         TORO_POINTS.innerText = parseInt(TORO_POINTS.innerText) + 1
     }

     function toreroWin() {
         TORERO_POINTS.innerText = parseInt(TORERO_POINTS.innerText) + 1
     }

     function getToro() {
         return {
             rotation: parseFloat(TORO_BODY.dataset.rotation),
             load: parseFloat(TORO_LOAD.dataset.load),
             x: parseFloat(TORO.dataset.x),
             y: parseFloat(TORO.dataset.y)
         }
     }

     function getTorero() {
         return {
             x: parseFloat(TORERO.dataset.x),
             y: parseFloat(TORERO.dataset.y),
             show_cape: KEYS_DOWN.Enter
         }
     }

     function setToro({rotation = 0, load = 0, x = 0, y = 0}={}) {
         TORO_BODY.dataset.rotation = rotation;
         TORO_LOAD.dataset.load = load;
         TORO.dataset.x = x;
         TORO.dataset.y = y;
         TORO_LOAD.style.transform = `scaleY(${TORO_LOAD.dataset.load})`;
         TORO_BODY.style.transform = `rotate(${TORO_BODY.dataset.rotation}deg)`;
         TORO.style.transform = `translate(${-TORO.dataset.x}px, ${-TORO.dataset.y}px)`;

     };

     function setTorero({show_cape = false, x = 0, y = 0}={}) {
         TORERO.dataset.x = x;
         TORERO.dataset.y = y;
         if (show_cape) TORERO_CAPE.style.display = 'block'
         else TORERO_CAPE.style.display = 'none'
         TORERO.style.transform = `translate(${TORERO.dataset.x}px, ${TORERO.dataset.y}px)`;
     };

     // HELPERS

     function shouldPersistKeyEvent(event) {
         return USER_TYPE == USER_TYPES.TORO && TORO_KEYS.has(event.code)
             || USER_TYPE == USER_TYPES.TORERO && TORERO_KEYS.has(event.code)
     };

     function onKeydown(event) {
         if (shouldPersistKeyEvent(event)) {
             KEYS_DOWN[event.code] = true;
             sendInput();
         }
     };

     function onKeyup(event) {
         if (shouldPersistKeyEvent(event)) {
             KEYS_DOWN[event.code] = false;
             sendInput();
         }
     };

     function handleOutOfBounds(entity) {
         if (entity.dataset.x > ARENA_SCREEN.offsetWidth - 40)
             entity.dataset.x = ARENA_SCREEN.offsetWidth - 40;
         else if (entity.dataset.x < 0) entity.dataset.x = 0;

         if (entity.dataset.y > ARENA_SCREEN.offsetHeight - 40)
             entity.dataset.y = ARENA_SCREEN.offsetHeight - 40;
         else if (entity.dataset.y < 0) entity.dataset.y = 0;
     };

     function detectCollisions() {
         if (checkCollision(TORO, TORERO)) {
             toroWin();
             return true;
         }

         if (checkCollision(TORO, TORERO_CAPE)) {
             toreroWin();
             return true;
         }
     };

     function checkCollision(entityA, entityB) {
         const a = entityA.getBoundingClientRect(),
               b = entityB.getBoundingClientRect(),
               xCollision = a.x >= b.left && a.x <= b.right || b.x >= a.left && b.x <= a.right,
               yCollision = a.y >= b.top && a.y < b.bottom || b.y >= a.top && b.y < a.bottom;

         return xCollision && yCollision
     };

     // INIT

     // 1. prompt to pick user
     function selectUser(event) {
         if (!event.target.dataset.user) return
         USER_TYPE = USER_TYPES[event.target.dataset.user]

         if (USER_TYPE == USER_TYPES.TORO)
             document.getElementById('scoreboard__toro').classList.add('selected')
         else if (USER_TYPE == USER_TYPES.TORERO)
             document.getElementById('scoreboard__torero').classList.add('selected')
         else if (USER_TYPE == USER_TYPES.SPECTATOR)
             document.getElementById('scoreboard__spectator').innerText = '(You are spectating)'

         USER_SELECT_SCREEN.style.display = 'none'
         attemptConnect()
     }

     // 1.5 join or start room
     function attemptConnect() {
         WAITING_PROMPT_INTERVAL = setInterval(updateWaitingPrompt, 200)
         WS.send(JSON.stringify({type: 'connect',
                                 user_type: USER_TYPE ? Symbol.keyFor(USER_TYPE) : null}))
     }

     function setGameID(id) {
         const gameIdEl = document.getElementById('game-room-id');

         if (id) gameIdEl.innerHTML = `Game ID: ${id}`;
         else gameIdEl.innerHTML = '';
     }

     function handleCreate({room_id}) {
         setGameID(room_id);
     }

     function setSpectatorCopy(raw_count) {
         let count = raw_count;
         let spectatorCopy = '';

         if (USER_TYPE == USER_TYPES.SPECTATOR) {
             count -= 1;

             if (!count)
                 spectatorCopy = '(You are spectating)';
             else if (count > 1)
                 spectatorCopy = `(You are spectating with ${count} others)`;
             else spectatorCopy = `(You are spectating with ${count} other)`;
         } else if (count) {
             if (count > 1)
                 spectatorCopy = `(${count} others are spectating)`
             else spectatorCopy = `(${count} other is spectating)`;
         }

         document.getElementById('scoreboard__spectator').innerText = spectatorCopy;
     }

     function handleJoin({room_id, user_type, complete, spectator_count}) {
         setGameID(room_id);
         setSpectatorCopy(spectator_count);

         if (complete) {
             WAITING_SCREEN.style.display = 'none'
             setupGame();
         }
     }

     function endGame() {
         USER_SELECT_SCREEN.style.display = '';
         WAITING_SCREEN.style.display = '';

         for (let e of document.getElementsByClassName('selected'))
             e.classList.remove('selected');
         setGameID();
     }

     function handleLeave({spectator_count, propagate}) {
         setSpectatorCopy(spectator_count);

         if (propagate) endGame();
     }

     function handleUpdate({keys, user_type, character}) {
         Object.assign(KEYS_DOWN, keys)

         if (USER_TYPES[user_type] == USER_TYPES.TORO)
             setToro(character)
         else if (USER_TYPES[user_type] == USER_TYPES.TORERO)
             setTorero(character)

         if (detectCollisions()) {
             document.removeEventListener('keydown', onKeydown);
             document.removeEventListener('keyup', onKeyup);
             console.log('game over')
         }
     }

     const WSHandlers = Object.freeze({
         create: handleCreate,
         join: handleJoin,
         leave: handleLeave,
         update: handleUpdate
     })

     WS.onmessage = function (frame) {
         const message = JSON.parse(frame.data)

         if (message.type != 'error') {
             try {
                 WSHandlers[message.type](message)
             } catch (e) {
                 console.error(`Unhandled message ${message}`)
                 throw e
             }
         }
         else console.error(message)
     }

     USER_SELECT_SCREEN.addEventListener('click', selectUser)

     // 2. wait for other player
     function updateWaitingPrompt() {
         let prompt;

         if (USER_TYPE == USER_TYPES.SPECTATOR) prompt = 'Finding players...'
         else prompt = `Finding a ${USER_TYPE == USER_TYPES.TORO ? 'Torero' : 'Toro'}...`

         // gotta us innerHTML because innerText trims the string preventing
         // increments to length upon first encountered space
         if (WAITING_PROMPT_EL.innerHTML.length == prompt.length)
             WAITING_PROMPT_EL.innerHTML = ''
         else
             WAITING_PROMPT_EL.innerHTML = prompt.slice(0, WAITING_PROMPT_EL.innerHTML.length + 1)

     }

     // 3. setup game
     function sendInput() {
         if (USER_TYPE == USER_TYPES.SPECTATOR) return
         let keySet;

         if (USER_TYPE == USER_TYPES.TORERO) {
             keySet = TORERO_KEYS
             character = getTorero()
             console.log(character)
         } else if (USER_TYPE == USER_TYPES.TORO) {
             keySet = TORO_KEYS
             character = getToro()
         }

         const keys = Array.from(keySet)
                           .reduce(
                               (rv, k) => {
                                   rv[k] = KEYS_DOWN[k]
                                   return rv
                               }, {})

         WS.send(JSON.stringify({type: 'input', keys, character}))
     }
    </script>
</body>
